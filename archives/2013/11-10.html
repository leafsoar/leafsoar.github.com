
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>玩转 Cocos2d-x 脚本引擎 - /无间落叶</title>
  <meta name="author" content="一叶">

  
  <meta name="description" content="[叶落归根]： <a href='http://blog.leafsoar.com/archives/2013/11-10.html' rel='bookmark' title='玩转 Cocos2d-x 脚本引擎'>http://blog.leafsoar.com/archives/2013/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.leafsoar.com/archives/2013/11-10.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="/无间落叶" type="application/atom+xml">
  <!-- font-family: 'Knewave', cursive; -->
<link href='http://fonts.googleapis.com/css?family=Knewave' rel='stylesheet' type='text/css'>
<!-- font-family: 'Cantata One', serif; -->
<link href='http://fonts.googleapis.com/css?family=Cantata+One' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-34041741-6']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1>
      <a href="/">/无间落叶</a>
      
        <span>无有入无间 ～</span>
      
  </h1>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
  <li><a href="http://weibo.com/leafsoar" rel="subscribe-weibo" title="subscribe via weibo" target="_blank">
	  <img src="/images/weibo_icon.png" width="26" height="21" alt="weibo" title="weibo" />
  </a></li>
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.leafsoar.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/cocos2d-x">Cocos2d-x</a></li>
  <li><a href="/about">About</a></li>  
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">玩转 Cocos2d-x 脚本引擎</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-10T20:56:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
        
      </p>
    
  </header>


<div class="entry-content">
  <p>
	<a href='http://blog.leafsoar.com' rel='bookmark' title='【无间落叶:无有入无间 ~】'>[叶落归根]</a>：
	<a href='http://blog.leafsoar.com/archives/2013/11-10.html' rel='bookmark'
           title='玩转 Cocos2d-x 脚本引擎'>http://blog.leafsoar.com/archives/2013/11-10.html</a>    
  </p>  
  <p>在 Unix 文化中，有这样一种理念，Happy Hacking！使用 Cocos2d-x/C++ 写过一些游戏，其绑定的脚本语言，用的也不少，脚本语言的一个好处就是快速开发，你无需明白它之运行机理，便可容易的完成所想要的效果，三天上手，五天就能写出像样的程序来，C++ 则不然，其各种语言细节特性，各种开发技巧，内存管理等细枝末叶 ~</p>

<p>计算机不会魔法，在一叶看来其内容，只有 <strong>“知、或者不知”</strong> ，没有 <strong>“懂、或者不懂”</strong>，“知或者不知”来自于你的学习历程与经验，至于“不懂”么，我还没接触到的领域内容，我都不懂，哈 ~ Cocos2d-x 脚本引擎也用过一段时间了，但其运行机理还不明白，就使用而言也无需明白，不过于在意细节的实现，可能更好的从宏观角度把握整体。过去只是对其“存疑”（对于这里的“不懂”，一叶通常美其名曰：<strong>要学会存疑</strong> :p ），而现在想要对其运行机制多了解一些，那就只有一步步去探究喽，要了解到什么程度，那就随意了～</p>

<p>对 Cocos2d-x 的运行机制只是略懂一二，C++ 的场景由 C++ 运行，脚本呢，先开启脚本引擎，让后将控制权交由脚本代码执行，在这过程中发生了什么，由脚本所控制的元素和 C++ 有什么不同，或者说它的本质是什么！这之前一叶一直说的是脚本引擎，而非具体那种脚本引擎，lua 或者 js (jsvascript)的引擎实现！凭着对已有知识的了解和直觉，很多疑问和可能性随之而来，它所支持的脚本语言有两种，此两种的共同之处是什么，其使用了脚本绑定技术，<strong>什么是绑定</strong> ？各种对象在内存中如何分布，如何配合在一起工作。</p>

<p>为了增加探究过程的趣味性，所以一叶试想着能不能让 Cocos2d-x 现今所支持的<strong>两种脚本引擎同时运行</strong> (lua and js)，然后确定是否能在三者之间（C++, js, lua）访问同一个内存元素，如果行，便弄出来，即便不能做到，那也无所谓，这其中的过程比结果更有意思，不是吗 ~</p>

<!-- More -->


<h2>两种脚本引擎同时运行</h2>

<p>这里使用了 cocos2d-x-3.0alpha0-pre 版本，原因有二。一者：这是最新版本，反正是折腾，顺便了解一下 3.0 的新特性和 代码 style ，其二：3.0 对 三大开发平台(windows, linux ,mac)，两大运行平台(android, ios)的支持更好更全一些，比如，lua 可以跑在 mac 上面，这一点最新的 2.2 版本不行（lua ）。这样的选择，可以让我在当前系统（Mac OS X） 系统下，直接运行看效果，而不用开模拟器或者虚拟机，使过程更为方便。（过去使用 Linux 作为开发环境，也很方便，一叶的博客也有其具体的开发环境搭建配置等）而 windows 系统，几年前就几乎不怎么用了，各种不顺手。</p>

<p>3.0 中去除了使用项目模板来构建项目，而改为使用脚本创建，支持的平台如下(这个脚本是 github 上最新的版本)，观其关键代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># [Cocos2d-x]/tools/project-creator/create_project.py</span>
</span><span class='line'><span class="n">PLATFORMS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s">&quot;cpp&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&quot;ios_mac&quot;</span><span class="p">,</span> <span class="s">&quot;android&quot;</span><span class="p">,</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="s">&quot;lua&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&quot;ios_mac&quot;</span><span class="p">,</span> <span class="s">&quot;android&quot;</span><span class="p">,</span> <span class="s">&quot;win32&quot;</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">],</span>
</span><span class='line'>  <span class="s">&quot;javascript&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&quot;ios_mac&quot;</span><span class="p">,</span> <span class="s">&quot;android&quot;</span><span class="p">,</span> <span class="s">&quot;win32&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>从这里脚本看出 cpp 和 lua ，对五个平台已经全面支持，javascript 对 linux 还没有支持（脚本上是这样），相比 -x 2.x 版本支持更好，更全面，其代码也经过重构，更模块化，还有很多 C++ 11 的新特性，这里同样也期待 3.0 早日成熟，达到实用阶段 :p</p>

<p>为了简化操作步骤，一叶尽量利用现有的环境内容，使用 XCode打开 samples 项目，这里包含了所有项目内容，起初一叶打算基于 HelloCpp 项目做扩展，添加脚本支持，来实现自己的功能，也许是我对 XCode 环境了解不够，通过手动配置，让它能够支持 lua 扩展，但是 js 扩展却没能跑起来（没理由 lua 可以 js 却不行，知道一定是哪里配置有误），此时看来，在已有的项目中添加 lua 比 js 成功几率要大，固转而使用 HelloLua 项目添加 js 扩展支持，以达到项目组织上能够独立运行 js 引擎 或者 lua 引擎。（注：使用 HelloCpp 作为扩展，主要想看看怎么配置方便，如果都好配置，就基于 Cpp ，如果其中一个配置难，或者没通过，就基于没有通过配置的已有实现，扩展它。比如，这里 lua 通过 js 却没有，那就基于已有的 HelloLua 扩展支持 js，更为节省精力，这是策略问题 :p）</p>

<p>以上只是让项目同时支持 js <strong>或者</strong> lua 的运行，比如只跑 lua，或者只跑 js，但是 两者却不能同时跑，如果在代码中，同时用到了 lua 和 js 的支持库，在编译时会报错。这是因为在绑定的时候，两种脚本引擎分别实现了自己的 GLNode 。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// [Cocos2d-x]/scripting/javascript/bindings/js_bindings_opengl.h</span>
</span><span class='line'><span class="cp">#include &quot;cocos2d.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;ScriptingCore.h&quot;</span>
</span><span class='line'><span class="cp">#include &quot;cocos2d_specifics.hpp&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">GLNode</span> <span class="o">:</span> <span class="k">public</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">Node</span> <span class="p">{</span>
</span><span class='line'> <span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">draw</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">js_register_cocos2dx_GLNode</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">JSObject</span> <span class="o">*</span><span class="n">global</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// [Cocos2d-x]/scripting/lua/cocos2dx_support/LuaOpengl.h</span>
</span><span class='line'><span class="cp">#ifndef __LUA_OPENGL_H__</span>
</span><span class='line'><span class="cp">#define __LUA_OPENGL_H__</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef __cplusplus</span>
</span><span class='line'><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#include &quot;tolua++.h&quot;</span>
</span><span class='line'><span class="cp">#ifdef __cplusplus</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;base_nodes/CCNode.h&quot;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">GLNode</span><span class="o">:</span><span class="k">public</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">Node</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">draw</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">TOLUA_API</span> <span class="kt">int</span> <span class="n">tolua_Cocos2d_CCDrawNode_drawPolygon00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">TOLUA_API</span> <span class="kt">int</span> <span class="n">tolua_opengl_open</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif </span><span class="c1">//__LUA_OPENGL_H__</span>
</span></code></pre></td></tr></table></div></figure>


<p>同时使用两种引擎，就意味着同时用到两者的库依赖，而重复的类型定义导致编译通不过，所以只能根据需要 hack 源码了，如果修改，二者修改其一，看修改哪个方便，引用的地方少。如下是使用 Emacs 的 find-grep 命令，在 scripting 目录搜索 &ldquo;GLNode&rdquo; 关键字的结果。（Emacs 是一叶的必备工具，这里搜索出的结果可以快速定位代码位置）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="o">-*-</span> <span class="nl">mode:</span> <span class="n">grep</span><span class="p">;</span> <span class="k">default</span><span class="o">-</span><span class="nl">directory:</span> <span class="s">&quot;~/Tools/cocos2d-x/cocos2d-x-3.0alpha0-pre/scripting/&quot;</span> <span class="o">-*-</span>
</span><span class='line'><span class="n">Grep</span> <span class="n">started</span> <span class="n">at</span> <span class="n">Mon</span> <span class="n">Nov</span> <span class="mi">11</span> <span class="mi">13</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mo">04</span>
</span><span class='line'>
</span><span class='line'><span class="n">find</span> <span class="p">.</span> <span class="o">-</span><span class="n">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">exec</span> <span class="n">grep</span> <span class="o">-</span><span class="n">nH</span> <span class="o">-</span><span class="n">e</span> <span class="n">GLNode</span> <span class="p">{}</span> <span class="o">+</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">jsb_cocos2d_extension</span><span class="p">.</span><span class="nl">js:</span><span class="mi">167</span><span class="o">:</span><span class="n">cc</span><span class="p">.</span><span class="n">GLNode</span><span class="p">.</span><span class="n">extend</span> <span class="o">=</span> <span class="n">cc</span><span class="p">.</span><span class="n">Class</span><span class="p">.</span><span class="n">extend</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">3</span><span class="o">:</span><span class="kt">void</span> <span class="n">GLNode</span><span class="o">::</span><span class="n">draw</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">27</span><span class="o">:</span><span class="n">JSClass</span>  <span class="o">*</span><span class="n">js_cocos2dx_GLNode_class</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">28</span><span class="o">:</span><span class="n">JSObject</span> <span class="o">*</span><span class="n">js_cocos2dx_GLNode_prototype</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">30</span><span class="o">:</span><span class="n">JSBool</span> <span class="n">js_cocos2dx_GLNode_constructor</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">jsval</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">34</span><span class="o">:</span>    <span class="n">GLNode</span><span class="o">*</span> <span class="n">cobj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GLNode</span><span class="p">();</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">41</span><span class="o">:</span>    <span class="n">TypeTest</span><span class="o">&lt;</span><span class="n">GLNode</span><span class="o">&gt;</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">51</span><span class="o">:</span>    <span class="n">JS_AddNamedObjectRoot</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;cocos2d::GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">59</span><span class="o">:</span><span class="kt">void</span> <span class="n">js_cocos2dx_GLNode_finalize</span><span class="p">(</span><span class="n">JSFreeOp</span> <span class="o">*</span><span class="n">fop</span><span class="p">,</span> <span class="n">JSObject</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">62</span><span class="o">:</span><span class="k">static</span> <span class="n">JSBool</span> <span class="n">js_cocos2dx_GLNode_ctor</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">jsval</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">65</span><span class="o">:</span>    <span class="n">GLNode</span> <span class="o">*</span><span class="n">nobj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GLNode</span><span class="p">();</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">68</span><span class="o">:</span>    <span class="n">JS_AddNamedObjectRoot</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">,</span> <span class="s">&quot;GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">73</span><span class="o">:</span><span class="n">JSBool</span> <span class="n">js_cocos2dx_GLNode_create</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">argc</span><span class="p">,</span> <span class="n">jsval</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">75</span><span class="o">:</span>  <span class="n">GLNode</span><span class="o">*</span> <span class="n">ret</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GLNode</span><span class="p">();</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">79</span><span class="o">:</span>      <span class="n">js_proxy_t</span> <span class="o">*</span><span class="n">proxy</span> <span class="o">=</span> <span class="n">js_get_or_create_proxy</span><span class="o">&lt;</span><span class="n">GLNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">91</span><span class="o">:</span><span class="kt">void</span> <span class="n">js_register_cocos2dx_GLNode</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">JSObject</span> <span class="o">*</span><span class="n">global</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">92</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span> <span class="o">=</span> <span class="p">(</span><span class="n">JSClass</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">JSClass</span><span class="p">));</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">93</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;GLNode&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">94</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">addProperty</span> <span class="o">=</span> <span class="n">JS_PropertyStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">95</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">delProperty</span> <span class="o">=</span> <span class="n">JS_PropertyStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">96</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">getProperty</span> <span class="o">=</span> <span class="n">JS_PropertyStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">97</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">setProperty</span> <span class="o">=</span> <span class="n">JS_StrictPropertyStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">98</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">enumerate</span> <span class="o">=</span> <span class="n">JS_EnumerateStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">99</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">JS_ResolveStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">100</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">convert</span> <span class="o">=</span> <span class="n">JS_ConvertStub</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">101</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">finalize</span> <span class="o">=</span> <span class="n">js_cocos2dx_GLNode_finalize</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">102</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_class</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">JSCLASS_HAS_RESERVED_SLOTS</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">109</span><span class="o">:</span>      <span class="n">JS_FN</span><span class="p">(</span><span class="s">&quot;ctor&quot;</span><span class="p">,</span> <span class="n">js_cocos2dx_GLNode_ctor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JSPROP_PERMANENT</span> <span class="o">|</span> <span class="n">JSPROP_ENUMERATE</span><span class="p">),</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">114</span><span class="o">:</span>    <span class="n">JS_FN</span><span class="p">(</span><span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">js_cocos2dx_GLNode_create</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">JSPROP_PERMANENT</span> <span class="o">|</span> <span class="n">JSPROP_ENUMERATE</span><span class="p">),</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">118</span><span class="o">:</span>  <span class="n">js_cocos2dx_GLNode_prototype</span> <span class="o">=</span> <span class="n">JS_InitClass</span><span class="p">(</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">121</span><span class="o">:</span>                         <span class="n">js_cocos2dx_GLNode_class</span><span class="p">,</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">122</span><span class="o">:</span>                         <span class="n">js_cocos2dx_GLNode_constructor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// constructor</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">129</span><span class="o">:</span>  <span class="n">JS_SetPropertyAttributes</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="s">&quot;GLNode&quot;</span><span class="p">,</span> <span class="n">JSPROP_ENUMERATE</span> <span class="o">|</span> <span class="n">JSPROP_READONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">found</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">132</span><span class="o">:</span>  <span class="n">TypeTest</span><span class="o">&lt;</span><span class="n">GLNode</span><span class="o">&gt;</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">139</span><span class="o">:</span>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">jsclass</span> <span class="o">=</span> <span class="n">js_cocos2dx_GLNode_class</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">140</span><span class="o">:</span>    <span class="n">p</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">js_cocos2dx_GLNode_prototype</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">h:</span><span class="mi">5</span><span class="o">:</span><span class="k">class</span> <span class="nc">GLNode</span> <span class="o">:</span> <span class="k">public</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">Node</span> <span class="p">{</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">js_bindings_opengl</span><span class="p">.</span><span class="nl">h:</span><span class="mi">10</span><span class="o">:</span><span class="kt">void</span> <span class="n">js_register_cocos2dx_GLNode</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">JSObject</span> <span class="o">*</span><span class="n">global</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">jsb_opengl_registration</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">56</span><span class="o">:</span>    <span class="n">js_register_cocos2dx_GLNode</span><span class="p">(</span><span class="n">_cx</span><span class="p">,</span> <span class="n">ccns</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">javascript</span><span class="o">/</span><span class="n">bindings</span><span class="o">/</span><span class="n">obfuscate</span><span class="o">/</span><span class="n">obfuscate_exclude_cocos2d</span><span class="p">.</span><span class="nl">js:</span><span class="mi">3049</span><span class="o">:</span><span class="n">CSSProperties</span><span class="p">.</span><span class="n">prototype</span><span class="p">.</span><span class="n">GLNode</span><span class="p">;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">615</span><span class="o">:</span>    <span class="n">extendGLNode</span><span class="p">(</span><span class="n">lua_S</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">726</span><span class="o">:</span><span class="kt">void</span> <span class="n">LuaEngine</span><span class="o">::</span><span class="n">extendGLNode</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">lua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">731</span><span class="o">:</span>    <span class="n">lua_pushstring</span><span class="p">(</span><span class="n">lua_S</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">736</span><span class="o">:</span>        <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">lua_S</span><span class="p">,</span><span class="n">tolua_Cocos2d_GLNode_registerScriptDrawHandler00</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">739</span><span class="o">:</span>        <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">lua_S</span><span class="p">,</span><span class="n">tolua_Cocos2d_GLNode_unregisterScriptDrawHandler00</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">CCLuaEngine</span><span class="p">.</span><span class="nl">h:</span><span class="mi">146</span><span class="o">:</span>    <span class="kt">void</span> <span class="n">extendGLNode</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">lua_S</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">24</span><span class="o">:</span><span class="kt">void</span> <span class="n">GLNode</span><span class="o">::</span><span class="n">draw</span><span class="p">()</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">26</span><span class="o">:</span>    <span class="kt">int</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getObjectHandler</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">,</span> <span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">kGLNodeDrawHandler</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">38</span><span class="o">:</span>    <span class="n">tolua_usertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="s">&quot;GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">42</span><span class="o">:</span><span class="k">static</span> <span class="kt">int</span> <span class="n">tolua_collect_GLNode</span> <span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">44</span><span class="o">:</span>    <span class="n">GLNode</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">GLNode</span><span class="o">*</span><span class="p">)</span> <span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">63</span><span class="o">:</span><span class="cm">/* method: create of class  GLNode */</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">64</span><span class="o">:</span><span class="err">#</span><span class="n">ifndef</span> <span class="n">TOLUA_DISABLE_tolua_Cocos2d_GLNode_create00</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">65</span><span class="o">:</span><span class="k">static</span> <span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_create00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">70</span><span class="o">:</span>        <span class="o">!</span><span class="n">tolua_isusertable</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tolua_err</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">77</span><span class="o">:</span>        <span class="n">GLNode</span> <span class="o">*</span><span class="n">glNode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GLNode</span><span class="p">();</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">83</span><span class="o">:</span>            <span class="n">toluafix_pushusertype_ccobject</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="n">nID</span><span class="p">,</span> <span class="n">pLuaID</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">glNode</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">100</span><span class="o">:</span><span class="cm">/* method: setShaderProgram of class  GLNode */</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">101</span><span class="o">:</span><span class="err">#</span><span class="n">ifndef</span> <span class="n">TOLUA_DISABLE_tolua_Cocos2d_GLNode_setShaderProgram00</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">102</span><span class="o">:</span><span class="k">static</span> <span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_setShaderProgram00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">107</span><span class="o">:</span>        <span class="o">!</span><span class="n">tolua_isusertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tolua_err</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">115</span><span class="o">:</span>        <span class="n">GLNode</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">GLNode</span><span class="o">*</span><span class="p">)</span>  <span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">292</span><span class="o">:</span><span class="cm">/* method: glBindFramebuffer of class  GLNode */</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">300</span><span class="o">:</span>        <span class="o">!</span><span class="n">tolua_isusertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tolua_err</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">6386</span><span class="o">:</span>      <span class="n">tolua_cclass</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="s">&quot;CCNode&quot;</span><span class="p">,</span><span class="n">tolua_collect_GLNode</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">6387</span><span class="o">:</span>        <span class="n">tolua_beginmodule</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">6388</span><span class="o">:</span>            <span class="n">tolua_function</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="s">&quot;create&quot;</span><span class="p">,</span> <span class="n">tolua_Cocos2d_GLNode_create00</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">6389</span><span class="o">:</span>            <span class="n">tolua_function</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span> <span class="s">&quot;setShaderProgram&quot;</span><span class="p">,</span> <span class="n">tolua_Cocos2d_GLNode_setShaderProgram00</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaOpengl</span><span class="p">.</span><span class="nl">h:</span><span class="mi">13</span><span class="o">:</span><span class="k">class</span> <span class="nc">GLNode</span><span class="o">:</span><span class="k">public</span> <span class="n">cocos2d</span><span class="o">::</span><span class="n">Node</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">584</span><span class="o">:</span><span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_registerScriptDrawHandler00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">588</span><span class="o">:</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tolua_isusertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tolua_err</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">595</span><span class="o">:</span>        <span class="n">GLNode</span><span class="o">*</span> <span class="n">glNode</span> <span class="o">=</span> <span class="p">(</span><span class="n">GLNode</span><span class="o">*</span><span class="p">)</span>  <span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">597</span><span class="o">:</span>        <span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addObjectHandler</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">glNode</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">kGLNodeDrawHandler</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">608</span><span class="o">:</span><span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_unregisterScriptDrawHandler00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">612</span><span class="o">:</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tolua_isusertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;GLNode&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tolua_err</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">618</span><span class="o">:</span>        <span class="n">GLNode</span><span class="o">*</span> <span class="n">glNode</span> <span class="o">=</span> <span class="p">(</span><span class="n">GLNode</span><span class="o">*</span><span class="p">)</span><span class="n">tolua_tousertype</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">619</span><span class="o">:</span>        <span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">removeObjectHandler</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">glNode</span><span class="p">,</span><span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">kGLNodeDrawHandler</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">cpp:</span><span class="mi">779</span><span class="o">:</span>        <span class="n">tolua_constant</span><span class="p">(</span><span class="n">tolua_S</span><span class="p">,</span><span class="s">&quot;kGLNodeDrawHandler&quot;</span><span class="p">,</span><span class="n">ScriptHandlerMgr</span><span class="o">::</span><span class="n">kGLNodeDrawHandler</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">h:</span><span class="mi">99</span><span class="o">:</span>       <span class="n">kGLNodeDrawHandler</span><span class="p">,</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">h:</span><span class="mi">137</span><span class="o">:</span><span class="n">TOLUA_API</span> <span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_registerScriptDrawHandler00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">cocos2dx_support</span><span class="o">/</span><span class="n">LuaScriptHandlerMgr</span><span class="p">.</span><span class="nl">h:</span><span class="mi">138</span><span class="o">:</span><span class="n">TOLUA_API</span> <span class="kt">int</span> <span class="n">tolua_Cocos2d_GLNode_unregisterScriptDrawHandler00</span><span class="p">(</span><span class="n">lua_State</span><span class="o">*</span> <span class="n">tolua_S</span><span class="p">);</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">lua</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">Opengl</span><span class="p">.</span><span class="nl">lua:</span><span class="mi">297</span><span class="o">:</span>    <span class="k">return</span> <span class="nl">GLNode:</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'><span class="n">Grep</span> <span class="n">finished</span> <span class="p">(</span><span class="n">matches</span> <span class="n">found</span><span class="p">)</span> <span class="n">at</span> <span class="n">Mon</span> <span class="n">Nov</span> <span class="mi">11</span> <span class="mi">13</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mo">07</span>
</span></code></pre></td></tr></table></div></figure>


<p>目测感觉两者差不多，而且代码量也不多，所以修改其中之一的 GLNode 类名称是可行的，总共八十多行结果，修改一种就四十行左右，而且其中出现的 &ldquo;GLNode&rdquo; 关键字，并不是都需要修改，有的是绑定到脚本引擎内部的，我们只需要修改其 C++ 端绑定的类型就 OK 了，一叶修改了 lua 绑定中的 GLNode 名字为 LuaGLNode，然后定位到 LuaOpengl 和相关文件（两个文件左右），查找并替换其中一部分 &ldquo;GLNode&rdquo; 关键字代码，这里借助 Emacs ，递进式的关键字查询替换，通过匹配规则，一个个过滤，手动选择是替换还是不替换，最后替换了所有 C++ 中 Lua 端的 GLNode 类名实现（替换的内容很少，比我想象中要少）。</p>

<p>到这里就已经完成能够让两种脚本引擎同时运行的方法。并且一叶修改了入口函数，在 AppDelegate 入口处，添加修改：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">bool</span> <span class="n">AppDelegate</span><span class="o">::</span><span class="n">applicationDidFinishLaunching</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// initialize director</span>
</span><span class='line'>    <span class="n">Director</span> <span class="o">*</span><span class="n">pDirector</span> <span class="o">=</span> <span class="n">Director</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
</span><span class='line'>    <span class="n">pDirector</span><span class="o">-&gt;</span><span class="n">setOpenGLView</span><span class="p">(</span><span class="n">EGLView</span><span class="o">::</span><span class="n">getInstance</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">EGLView</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setDesignResolutionSize</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="n">ResolutionPolicy</span><span class="o">::</span><span class="n">NO_BORDER</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// turn on display FPS</span>
</span><span class='line'>    <span class="n">pDirector</span><span class="o">-&gt;</span><span class="n">setDisplayStats</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// set FPS. the default value is 1.0/60 if you don&#39;t call this</span>
</span><span class='line'>    <span class="n">pDirector</span><span class="o">-&gt;</span><span class="n">setAnimationInterval</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//    runLua();</span>
</span><span class='line'>    <span class="n">runCpp</span><span class="p">();</span>
</span><span class='line'><span class="c1">//    runJsb();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">AppDelegate</span><span class="o">::</span><span class="n">runCpp</span><span class="p">(){</span>
</span><span class='line'>    <span class="k">auto</span> <span class="n">scene</span> <span class="o">=</span> <span class="n">HelloLeafsoar</span><span class="o">::</span><span class="n">scene</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Director</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">runWithScene</span><span class="p">(</span><span class="n">scene</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">AppDelegate</span><span class="o">::</span><span class="n">runJsb</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">ScriptingCore</span><span class="o">*</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ScriptingCore</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">register_all_cocos2dx</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">register_all_cocos2dx_extension</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">register_cocos2dx_js_extensions</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">jsb_register_chipmunk</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">register_all_cocos2dx_extension_manual</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">register_CCBuilderReader</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">jsb_register_system</span><span class="p">);</span>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">addRegisterCallback</span><span class="p">(</span><span class="n">JSB_register_opengl</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ScriptEngineProtocol</span> <span class="o">*</span><span class="n">pEngine</span> <span class="o">=</span> <span class="n">ScriptingCore</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
</span><span class='line'>    <span class="n">ScriptEngineManager</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setScriptEngine</span><span class="p">(</span><span class="n">pEngine</span><span class="p">);</span>
</span><span class='line'>    <span class="n">ScriptingCore</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">runScript</span><span class="p">(</span><span class="s">&quot;main.js&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">AppDelegate</span><span class="o">::</span><span class="n">runLua</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">LuaEngine</span><span class="o">*</span> <span class="n">luaEngine</span> <span class="o">=</span> <span class="n">LuaEngine</span><span class="o">::</span><span class="n">getInstance</span><span class="p">();</span>
</span><span class='line'>    <span class="n">ScriptEngineManager</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setScriptEngine</span><span class="p">(</span><span class="n">luaEngine</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">path</span> <span class="o">=</span> <span class="n">FileUtils</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">fullPathForFilename</span><span class="p">(</span><span class="s">&quot;hello.lua&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">luaEngine</span><span class="o">-&gt;</span><span class="n">executeScriptFile</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到这里有三个方法，runCpp 、runLua 和 runJsb，这三者可单独独立运行，也可同时运行，在脚本实现不同的 log 打印，便能知晓，但如如果你在这三处同时运行了一个场景的话，那么根据场景的运行规则，后面运行的场景会入栈，替换之前场景的运行，三者的运行顺序，可以随意修改，并观其运行结果。为了测试这一点，我们同时运行 runLua、runCpp 和 runJsb ，然后使用一个全局定时器（请看 实现 <a href="http://blog.leafsoar.com/archives/2013/05-08.html">『Cocos2d-x 全局定时器』</a> 一文），每三秒钟弹出一个场景。而每一个场景的内部不同，这样我们便能看见首先运行了 runJsb 场景，三秒后 runLua ，之后 runCpp 场景，最终三秒后，所有场景弹出，Game Over 了。</p>

<h2>脚本绑定技术的特性</h2>

<p>以上通过对源代码的修改，一个例子，让 lua 和 js 两种脚本引擎同时运行，由于在任何时候只能有一个场景运行，所以，无论由 C++、lua 还是 js 来启动游戏，另外两种语言将会得不倒执行的权利，但是从另一个侧面，全局定时器它得的运行并不依赖场景的运行，这对我们研究程序执行过程中对象的特性提供了方便，前文通过一个 C++ 端实现的全局定时器，不论你运行的是不是脚本，是什么脚本，都不影响它之运行，那么我们就能能用这个定时器去定期的调用各种脚本，以让这三种脚本语言同时运行，在这样一个过程中，去验证对它们的内存分布，操作机制的的情况等 ~</p>

<p>一叶在 C++ 端开启了一个定时器，且由 C++ 运行了第一个场景，然后修改全局定时器的定时调用实现，添加对 lua 和 js 的脚本调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">void</span> <span class="n">GlobalSchedule</span><span class="o">::</span><span class="n">globalUpdate</span><span class="p">(</span><span class="kt">float</span> <span class="n">dt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 这里写全局定时器的逻辑处理代码</span>
</span><span class='line'>    <span class="n">CCLOG</span><span class="p">(</span><span class="s">&quot;global update&quot;</span><span class="p">);</span>
</span><span class='line'><span class="c1">//    Director::getInstance()-&gt;popScene();</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">++</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">auto</span> <span class="n">scene</span> <span class="o">=</span> <span class="n">Director</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getRunningScene</span><span class="p">();</span>
</span><span class='line'>    <span class="n">LabelTTF</span><span class="o">*</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="n">LabelTTF</span><span class="o">*</span><span class="p">)</span><span class="n">scene</span><span class="o">-&gt;</span><span class="n">getChildByTag</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">label</span><span class="p">){</span>
</span><span class='line'>        <span class="n">label</span> <span class="o">=</span> <span class="n">LabelTTF</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;一叶 v 5~&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
</span><span class='line'>        <span class="n">label</span><span class="o">-&gt;</span><span class="n">setPosition</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">));</span>
</span><span class='line'>        <span class="n">label</span><span class="o">-&gt;</span><span class="n">setColor</span><span class="p">(</span><span class="n">Color3B</span><span class="o">::</span><span class="n">BLACK</span><span class="p">);</span>
</span><span class='line'>        <span class="n">scene</span><span class="o">-&gt;</span><span class="n">addChild</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">label</span><span class="o">-&gt;</span><span class="n">setScale</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ScriptingCore</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">runScript</span><span class="p">(</span><span class="s">&quot;jsbMethod.js&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>            <span class="n">LuaEngine</span><span class="o">::</span><span class="n">getInstance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">executeScriptFile</span><span class="p">(</span><span class="s">&quot;luaMethod.lua&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是全局定时器的实现，它在当前运行的场景中添加了一个 Label ，label 的内容 &ldquo;<strong>一叶 v 5~</strong>&#8220;，并且通过一个执行技术 <strong>count</strong> 来决定当前执行的是 C++ 还是 lua 或者 js，在不同的语言中，修改同一个元素的大小 <strong>Scale</strong>，看看 js 和 lua 的 method 文件实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='lua'><span class='line'><span class="c1">-- luaMethod.lua 具体实现</span>
</span><span class='line'><span class="n">cclog</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">cclog</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">lua method .&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">local</span> <span class="n">scene</span> <span class="o">=</span> <span class="n">CCDirector</span><span class="p">:</span><span class="n">getInstance</span><span class="p">():</span><span class="n">getRunningScene</span><span class="p">()</span>
</span><span class='line'><span class="kd">local</span> <span class="n">label</span> <span class="o">=</span> <span class="n">scene</span><span class="p">:</span><span class="n">getChildByTag</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="n">label</span><span class="p">:</span><span class="n">setScale</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// jsbMethod.js 具体实现</span>
</span><span class='line'><span class="nx">cc</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot; jsb method .&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">scene</span> <span class="o">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">Director</span><span class="p">.</span><span class="nx">getInstance</span><span class="p">().</span><span class="nx">getRunningScene</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">getChildByTag</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span><span class='line'><span class="nx">label</span><span class="p">.</span><span class="nx">setScale</span><span class="p">(</span><span class="mf">1.2</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上的代码都很简单，各种语言的逻辑一样，首先或者当前运行着的场景，然后通过 tag 获取场景中的元素 Label，再之修改它的大小，这样将程序运行，便能看见此 Label 定时改变大小，而且是三种大小状态不停的切换，可见已经完成了我们之前的目标，双开脚本引擎，用不语言控制同一个元素（文章最后给出所有代码）。</p>

<h3>绑定技术的特性浅析</h3>

<p>说道脚本绑定技术，这里可以插入一个新的内容来说，Cocos2d-html5 版本！作为对比，更为明了，h5 的实现和 jsb 的实现显然不同，h5 是跑在浏览器上的，jsb 是跑在移动终端上的。但是它们都用统一的接口实现，即用 js 写的游戏（同一套代码）即能够跑在浏览器上，又能够能跑在手机的 js 引擎上，这两者之间 <strong>表面相同，本质不同 </strong>，也是隐藏了内部实现，提供统一的接口让写程序更为简单。有兴趣的朋友可以去了解一下。在 Emacs 内置的 lisp 语言函数中有很多性能要求比较高的是使用 c 语言实现的，但在调用的时候全然不知（不知道就对了）。</p>

<p>而 jsb 和 lua 之间：知其不同，是见其表，知其皆同，是知其本，舍不同而观其同，可游心于物之初，哈。 在脚本引擎库中，以 C++ 实现的类型为基本，通过动态往虚拟机（引擎环境，或者上下文对象）里添加类型定义并绑定，每钟脚本类型都有其对应的 C++ 类型作为依据，通过脚本创建的对象最终被映射为调用 C++ 创建对象，而在 C++ 中创建的对象，也可以在脚本中随时获取，并修改其属性，当然其内部还有复杂的内存管理解决方案 (特别是本文中这样混合形的运行时环境，其对象生命周期就更复杂了，关系到引擎内部实现的细节，由不同语言创建的对象，由谁管理，由谁释放等等)，在需要之时可以深究，而这里显然没有必要（这里引擎双开仅作学习之用），宏观角度考量，内存管理无非是定义一套规则，或是规范，这样能保证出错误的最小可能性（在 <a href="http://blog.leafsoar.com/archives/2013/05-22.html">『Cocos2d-x 内存管理浅说』</a> , <a href="http://blog.leafsoar.com/archives/2013/05-29.html">『Cocos2d-x 内存管理的一种实现』</a>, <a href="http://blog.leafsoar.com/archives/2013/06-04.html">『深入理解 Cocos2d-x 内存管理』</a>) 几篇文章有怎样通过编程规范来尽量避免内存出现的问题）。</p>

<p>如果我们需要添加一种新脚本绑定实现，比如使用 lisp 语言作为绑定 （Emacs 用户首先想到的就是 lisp 了），那么我们需要一个 lisp 运行时环境的实现，然后通过函数绑定，javascript 和 lua 的第一类型是 函数（First-class Function），它们都有很强的函数式语言特性，其封装的 Cocos2d-x 调用方式不过是语法糖衣，看起来像面相对象而已，此点 js 表现更甚。所以对于 lisp 实现来说，是可行的，至于最后写起来是否顺手不得而知，目测如果实现，写法更像 lua 对 Cocos2d-x 的 style，可能很好使，可能很糟糕 :P 也许使用对象形的脚本语言更加合宜。</p>

<h2>非吾小天下 宏观而已</h2>

<p>想要玩转这里脚本引擎，那么你至少会绑定，知道怎么绑定，其具体步骤 ？jsb 怎么手动绑定，lua 怎么手动绑定，而且还有自动绑定脚本，jsb 的内部使用了 spidermonkey 开源的 js 引擎，lua 还可以开 jit，其运行环境有很多复杂的上下文参数，各种错综复杂，提出各种专有的概念，有着各自不同的游戏规则，其内部的细枝末叶是对具体问题的解决方案，然而有的时候我们并不知道需要解决的问题由来，一环套着一环，我在这里却避而不谈，一方面是因为我也不知 :p ,另一方面是因为不想让我或者别人陷入这样那样的泥沼中去，从宏观的角度去看问题，或者抽象，在 lua 和 js 这两种脚本引擎中，其特点为何，能达到什么样的效果，在本文的操作过程，并没有什么复杂的步骤，修改了一处编译报错问题，引擎双开，操作同一对象。避开了很多各脚本的内部实现细节内容。把复杂的问题简单化 ~</p>

<p>关于本文的内容，一叶会将代码项目提交到 github 以供参考（在文章最后给出<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>），内容不多，组织凌乱（时不时想修改，临时添加以看不同的测试效果），所以就将就着看了，哈，我的博文从不倾向给出一个完整的解决方案，以思路为重，其过程比结果更为重要。</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>本文环境及其代码：<a href="https://github.com/leafsoar/cocos2d-x-script-engine">https://github.com/leafsoar/cocos2d-x-script-engine</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>


</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">一叶</span></span>

      








  


<time datetime="2013-11-10T20:56:00+08:00" pubdate data-updated="true">Nov 10<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/archives/category/cocos2d-x/'>Cocos2d-x</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/archives/2013/07-27.html" title="Previous Post: CCScrollView 实现帮助界面、关卡选择">&laquo; CCScrollView 实现帮助界面、关卡选择</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section class="first odd">
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/2013/11-10.html">玩转 Cocos2d-x 脚本引擎</a>
      </li>
    
      <li class="post">
        <a href="/archives/2013/07-27.html">CCScrollView 实现帮助界面、关卡选择</a>
      </li>
    
      <li class="post">
        <a href="/archives/2013/06-04.html">深入理解 Cocos2d-x 内存管理</a>
      </li>
    
      <li class="post">
        <a href="/archives/2013/05-29.html">Cocos2d-x 内存管理的一种实现</a>
      </li>
    
      <li class="post">
        <a href="/archives/2013/05-25.html">多层 UI 触摸事件的轻量级设计</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/leafsoar">@leafsoar</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'leafsoar',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 一叶 -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> and <a href="https://github.com/gluttony/object-octopress-theme">Object</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'leafsoar';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.leafsoar.com/archives/2013/11-10.html';
        var disqus_url = 'http://blog.leafsoar.com/archives/2013/11-10.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
